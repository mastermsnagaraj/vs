<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V S TRADERS - POS with Images & Reports</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Styles for printing the bill */
        @media print {
            body * { visibility: hidden; }
            .printable-bill-area, .printable-bill-area * { visibility: visible; }
            .printable-bill-area { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%;
                max-width: 300px; /* Standard receipt width */
                margin: 0 auto;
                padding: 10px;
                font-size: 11px;
            }
            #app-container, .fixed { display: none !important; }
            /* Specific print area styles for reports */
            .printable-report-area { 
                visibility: visible !important; 
                position: static !important; 
                margin: 0;
                padding: 0;
                width: 100%;
                max-width: 100%;
                font-size: 12px;
            }
            .printable-report-area table { width: 100%; border-collapse: collapse; }
            .printable-report-area th, .printable-report-area td { border: 1px solid #ccc; padding: 4px; }
        }
        body { font-family: "Inter", sans-serif; background-color: #f3f4f6; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #166534; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: #dcfce7; }
        
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body class="min-h-screen flex flex-col text-gray-800">

    <header class="fixed top-0 left-0 right-0 bg-white border-b shadow-md p-3 z-30 flex justify-between items-center flex-wrap">
        <div class="flex items-center space-x-4 mb-2 md:mb-0">
            <h1 class="text-xl font-bold text-green-800">V S TRADERS</h1>
            <p class="text-xs text-gray-500 hidden sm:block">Inventory & POS System</p>
        </div>
        
        <div class="flex items-center space-x-2 flex-wrap">
            <select id="lang-switch" class="border border-green-300 rounded-lg p-1 text-sm bg-white text-green-800 focus:outline-none">
                <option value="auto">Auto Lang</option>
                <option value="en">English</option>
                <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</option>
            </select>
            <button onclick="openManagerModal('menu')" class="bg-indigo-600 text-white px-3 py-1 rounded-lg text-sm font-bold shadow hover:bg-indigo-700 transition">Menu</button>
            <button onclick="openManagerModal('inventory')" class="bg-yellow-600 text-white px-3 py-1 rounded-lg text-sm font-bold shadow hover:bg-yellow-700 transition">Stock</button>
            <button onclick="openReportsModal()" class="bg-purple-600 text-white px-3 py-1 rounded-lg text-sm font-bold shadow hover:bg-purple-700 transition">Reports</button>
            <button onclick="openQrModal()" class="bg-gray-700 text-white px-3 py-1 rounded-lg text-sm font-bold shadow hover:bg-gray-800 transition">QR</button>
        </div>
    </header>

    <div id="app-container" class="flex flex-1 flex-col lg:flex-row h-screen overflow-hidden mt-14">
        
        <main class="lg:w-2/3 p-4 overflow-y-auto flex flex-col pt-2">
            <div id="product-menu" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-4 gap-4 pb-4">
                </div>
        </main>

        <aside class="lg:w-1/3 bg-white border-l shadow-2xl flex flex-col z-20">
            <div class="p-4 bg-green-800 text-white shadow-md">
                <h2 class="text-lg font-bold">Billing Cart</h2>
            </div>

            <div id="cart-items-container" class="flex-1 overflow-y-auto p-4 space-y-2">
                <div id="cart-list" class="text-center text-gray-400 text-sm mt-10">Cart is empty</div>
            </div>

            <div class="p-4 bg-gray-50 border-t">
                <div class="flex justify-between text-xl font-bold text-gray-800 mb-4">
                    <span>Total:</span>
                    <span id="cart-total" class="text-green-700">‚Çπ0.00</span>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="openPaymentModal()" class="col-span-2 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow transition">PAY NOW</button>
                    <button onclick="printBill()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg text-sm">Print</button>
                    <button onclick="clearCart()" class="bg-red-100 hover:bg-red-200 text-red-600 font-bold py-2 rounded-lg text-sm">Clear</button>
                </div>
            </div>
        </aside>
    </div>

    <div id="generic-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center p-4 backdrop-blur-sm" onclick="closeModal(event)">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden" onclick="event.stopPropagation()">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800">Title</h3>
                <button onclick="closeGenericModal()" class="text-gray-500 hover:text-red-500 text-2xl">&times;</button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto custom-scrollbar"></div>
        </div>
    </div>

    <div id="payment-modal" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden items-center justify-center p-4" onclick="closeModal(event)">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 transform transition-all" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4">Complete Payment</h3>
            <div class="mb-4">
                <label class="text-xs font-bold text-gray-500 uppercase">Payment Mode</label>
                <select id="payment-mode" class="w-full border p-2 rounded mt-1 bg-gray-50">
                    <option value="cash">üíµ Cash</option>
                    <option value="upi">üì± UPI / QR</option>
                    <option value="card">üí≥ Card</option>
                </select>
            </div>
            <div id="qr-area" class="hidden mb-4 text-center p-2 bg-gray-50 rounded border">
                <img id="pay-qr-img" class="w-40 h-40 mx-auto object-contain bg-white">
                <p id="pay-qr-err" class="text-xs text-red-500 mt-2 hidden">QR Code not uploaded yet.</p>
            </div>
            <div class="text-center bg-green-50 p-4 rounded-lg border border-green-100 mb-4">
                <span class="block text-xs text-green-600 uppercase font-bold">Amount Due</span>
                <span id="pay-amount" class="text-3xl font-extrabold text-green-700">‚Çπ0.00</span>
            </div>
            <button onclick="finishSale()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-lg">CONFIRM SALE</button>
        </div>
    </div>
    
    <div class="fixed top-0 left-0 w-full h-full p-8 bg-white text-black z-[100] hidden" id="report-print-container">
        <div id="report-print" class="printable-report-area mx-auto max-w-4xl"></div>
        <div class="fixed top-4 right-4 z-[101] flex space-x-2">
            <button onclick="window.print()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-blue-700 print:hidden">Print Report</button>
            <button onclick="generateReportPdf()" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-red-700 print:hidden">PDF</button>
            <button onclick="document.getElementById('report-print-container').classList.add('hidden')" class="bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-gray-700 print:hidden">Close</button>
        </div>
    </div>

    <div id="toast-box" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>

    <script>
        // ================= STATE MANAGEMENT =================
        let menuItems = [];
        let inventory = {};
        let cart = [];
        let salesHistory = [];
        let qrCode = null;
        let nextId = 1;
        let isSaving = false;

        // Helper functions
        function closeModal(event) {
            if (event.target === document.getElementById('generic-modal')) closeGenericModal();
            if (event.target === document.getElementById('payment-modal')) closePaymentModal();
        }
        function closeGenericModal() { document.getElementById('generic-modal').classList.add('hidden'); }
        function closePaymentModal() { document.getElementById('payment-modal').classList.add('hidden'); }
        
        function formatCurrency(amount) {
            return `‚Çπ${(amount || 0).toFixed(2)}`;
        }
        
        function getDisplayName(item) {
            const lang = document.getElementById('lang-switch').value;
            const isTa = lang === 'ta' || (lang==='auto' && navigator.language.startsWith('ta'));
            return isTa ? (item.nameTa || item.nameEn) : item.nameEn;
        }

        function showToast(message, type = 'success') {
            const box = document.getElementById('toast-box');
            const color = type === 'error' ? 'bg-red-500' : (type === 'warning' ? 'bg-yellow-500' : 'bg-green-600');
            const toast = document.createElement('div');
            toast.className = `${color} text-white px-4 py-2 rounded-lg shadow-xl text-sm font-bold transition-all transform translate-x-full opacity-0`;
            toast.textContent = message;
            box.appendChild(toast);

            setTimeout(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
                toast.classList.add('translate-x-0', 'opacity-100');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('translate-x-0', 'opacity-100');
                toast.classList.add('translate-x-full', 'opacity-0');
            }, 3000);
            setTimeout(() => {
                toast.remove();
            }, 3500);
        }

        function openQrModal() {
            const modal = document.getElementById('generic-modal');
            const body = document.getElementById('modal-body');
            const title = document.getElementById('modal-title');

            modal.classList.remove('hidden'); modal.classList.add('flex');
            title.textContent = "Upload UPI QR Code (Max 150px)";
            
            body.innerHTML = `
                <div class="flex flex-col items-center p-4">
                    <img id="current-qr" src="${qrCode || ''}" class="w-48 h-48 object-contain mb-4 border p-2 bg-gray-50 ${qrCode ? '' : 'hidden'}">
                    <p id="qr-status" class="text-sm text-gray-500 mb-4">${qrCode ? 'Current QR Code loaded.' : 'No QR Code uploaded yet.'}</p>
                    <input id="qr-file-input" type="file" accept="image/*" class="mb-4 border p-2 rounded w-full">
                    <button onclick="uploadQrCode()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow">Upload & Save QR</button>
                    <button onclick="deleteQrCode()" class="mt-2 text-sm text-red-500 hover:text-red-700">Delete QR Code</button>
                </div>
            `;
        }
        async function uploadQrCode() {
            const fileInput = document.getElementById('qr-file-input');
            if (fileInput.files.length === 0) { showToast("Please select a file.", 'error'); return; }

            try {
                const imgData = await resizeImage(fileInput.files[0], 150, 0.7);
                qrCode = imgData;
                localStorage.setItem('vs_qr', qrCode);
                showToast("QR Code Saved!");
                openQrModal();
            } catch(e) {
                showToast("Image Upload Error. Try a smaller file.", 'error');
            }
        }
        function deleteQrCode() {
            if (confirm("Permanently delete the stored QR code?")) {
                qrCode = null;
                localStorage.removeItem('vs_qr');
                showToast("QR Code Deleted!");
                openQrModal();
            }
        }

        // Load Data on Start
        function init() {
            try {
                const ls = localStorage;
                if(ls.getItem('vs_menu')) menuItems = JSON.parse(ls.getItem('vs_menu'));
                else {
                    // Default Demo Data
                    menuItems = [
                        { id: '1', nameEn: 'Onion', nameTa: '‡Æµ‡ØÜ‡Æô‡Øç‡Æï‡Ææ‡ÆØ‡ÆÆ‡Øç', priceKg: 50, priceUnit: 0, img: null },
                        { id: '2', nameEn: 'Tomato', nameTa: '‡Æ§‡Æï‡Øç‡Æï‡Ææ‡Æ≥‡Æø', priceKg: 40, priceUnit: 0, img: null },
                        { id: '3', nameEn: 'Coconut', nameTa: '‡Æ§‡Øá‡Æô‡Øç‡Æï‡Ææ‡ÆØ‡Øç', priceKg: 0, priceUnit: 25, img: null },
                    ];
                    nextId = 4;
                }
                
                if(ls.getItem('vs_inv')) inventory = JSON.parse(ls.getItem('vs_inv'));
                else {
                    inventory = { '1': {kg: 10, unit: 0}, '2': {kg: 15, unit: 0}, '3': {kg: 0, unit: 50} };
                }

                if(ls.getItem('vs_hist')) salesHistory = JSON.parse(ls.getItem('vs_hist'));
                if(ls.getItem('vs_qr')) qrCode = ls.getItem('vs_qr');
                if(ls.getItem('vs_nid')) nextId = parseInt(ls.getItem('vs_nid'));

            } catch(e) { console.error(e); localStorage.clear(); }

            renderMenu();
            renderCart();
        }

        function save() {
            if (isSaving) return;
            isSaving = true;
            try {
                localStorage.setItem('vs_menu', JSON.stringify(menuItems));
                localStorage.setItem('vs_inv', JSON.stringify(inventory));
                localStorage.setItem('vs_hist', JSON.stringify(salesHistory));
                localStorage.setItem('vs_nid', nextId);
                if(qrCode) localStorage.setItem('vs_qr', qrCode);
            } catch(e) {
                console.error("Failed to save data to Local Storage:", e);
                showToast("Warning: Failed to save data. Local Storage might be full.", 'error');
            } finally {
                isSaving = false;
            }
        }

        // ================= IMAGE COMPRESSION LOGIC =================
        function resizeImage(file, maxWidth, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const elem = document.createElement('canvas');
                        const scaleFactor = maxWidth / img.width;
                        elem.width = maxWidth;
                        elem.height = img.height * scaleFactor;
                        if (elem.height > 150) { // Limit height as well for reasonable square-ish images
                            elem.height = 150;
                            elem.width = img.width * (150 / img.height);
                        }
                        const ctx = elem.getContext('2d');
                        ctx.drawImage(img, 0, 0, elem.width, elem.height);
                        resolve(elem.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = error => reject(error);
                };
            });
        }

        // ================= MENU MANAGER (ADD/EDIT/STOCK) =================
        let editingItemId = null;

        function openManagerModal(type) {
            const modal = document.getElementById('generic-modal');
            const body = document.getElementById('modal-body');
            const title = document.getElementById('modal-title');
            
            modal.classList.remove('hidden'); modal.classList.add('flex');
            body.innerHTML = '';
            
            if (type === 'menu') {
                title.textContent = "Manage Menu & Items";
                renderMenuEditor(body);
            } else if (type === 'inventory') {
                title.textContent = "Quick Stock Update";
                renderInventoryEditor(body);
            }
        }

        function renderMenuEditor(container) {
            const formHtml = `
                <div class="bg-gray-100 p-4 rounded-xl mb-6 border border-gray-200">
                    <h4 class="font-bold text-gray-700 mb-3 text-sm uppercase tracking-wide" id="form-heading">Add New Item</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <input id="in-name-en" type="text" placeholder="Name (English)" class="border p-2 rounded focus:ring-2 ring-green-500 outline-none">
                        <input id="in-name-ta" type="text" placeholder="Name (Tamil)" class="border p-2 rounded focus:ring-2 ring-green-500 outline-none">
                        
                        <div class="flex gap-2">
                            <input id="in-price-kg" type="number" placeholder="‚Çπ Price / Kg" class="border p-2 rounded w-full">
                            <input id="in-price-unit" type="number" placeholder="‚Çπ Price / Unit" class="border p-2 rounded w-full">
                        </div>

                        <div class="flex gap-2">
                            <input id="in-stock-kg" type="number" placeholder="Initial Kg Stock" class="border p-2 rounded w-full bg-yellow-50">
                            <input id="in-stock-unit" type="number" placeholder="Initial Unit Stock" class="border p-2 rounded w-full bg-yellow-50">
                        </div>
                        
                        <div class="col-span-1 md:col-span-2 flex items-center gap-2 border p-2 rounded bg-white">
                            <span class="text-xs font-bold text-gray-500">IMAGE:</span>
                            <input id="in-img" type="file" accept="image/*" class="text-sm w-full">
                        </div>
                    </div>
                    <div class="mt-4 flex gap-2 justify-end">
                        <button onclick="resetMenuForm()" class="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded text-sm font-bold">Cancel</button>
                        <button onclick="saveMenuItem()" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded text-sm font-bold shadow-lg" id="btn-save-item">Save Item</button>
                    </div>
                </div>

                <div class="overflow-x-auto rounded-lg border">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                            <tr>
                                <th class="px-4 py-3">Image</th>
                                <th class="px-4 py-3">Name</th>
                                <th class="px-4 py-3">Prices</th>
                                <th class="px-4 py-3 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="menu-table-body" class="divide-y">
                            </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = formHtml;
            renderMenuTableRows();
        }

        function renderMenuTableRows() {
            const tbody = document.getElementById('menu-table-body');
            tbody.innerHTML = '';
            
            [...menuItems].reverse().forEach(item => {
                const imgDisplay = item.img 
                    ? `<img src="${item.img}" class="w-10 h-10 object-cover rounded-full border">` 
                    : `<div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center text-lg">ü•¶</div>`;

                const row = document.createElement('tr');
                row.className = "hover:bg-gray-50 bg-white";
                row.innerHTML = `
                    <td class="px-4 py-2">${imgDisplay}</td>
                    <td class="px-4 py-2">
                        <div class="font-bold text-gray-800">${item.nameEn}</div>
                        <div class="text-xs text-gray-400">${item.nameTa}</div>
                    </td>
                    <td class="px-4 py-2">
                        ${item.priceKg > 0 ? `<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded mr-1">Kg: ${formatCurrency(item.priceKg)}</span>` : ''}
                        ${item.priceUnit > 0 ? `<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">Unit: ${formatCurrency(item.priceUnit)}</span>` : ''}
                    </td>
                    <td class="px-4 py-2 text-right space-x-2">
                        <button onclick="editMenuItem('${item.id}')" class="text-indigo-600 hover:text-indigo-900 font-bold text-xs border border-indigo-200 px-2 py-1 rounded">Edit</button>
                        <button onclick="deleteMenuItem('${item.id}')" class="text-red-600 hover:text-red-900 font-bold text-xs border border-red-200 px-2 py-1 rounded">Del</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function saveMenuItem() {
            const nameEn = document.getElementById('in-name-en').value.trim();
            const nameTa = document.getElementById('in-name-ta').value.trim();
            const priceKg = parseFloat(document.getElementById('in-price-kg').value) || 0;
            const priceUnit = parseFloat(document.getElementById('in-price-unit').value) || 0;
            const stockKg = parseFloat(document.getElementById('in-stock-kg').value) || 0;
            const stockUnit = parseFloat(document.getElementById('in-stock-unit').value) || 0;
            const fileInput = document.getElementById('in-img');

            if (!nameEn) { showToast("Name is required", 'error'); return; }
            if (priceKg === 0 && priceUnit === 0) { showToast("Set at least one price", 'error'); return; }

            let imgData = null;
            
            if (fileInput.files.length > 0) {
                try {
                    imgData = await resizeImage(fileInput.files[0], 150, 0.7);
                } catch(e) {
                    showToast("Image Error", 'error');
                    return;
                }
            }

            if (editingItemId) {
                const index = menuItems.findIndex(i => i.id === editingItemId);
                if (index !== -1) {
                    menuItems[index].nameEn = nameEn;
                    menuItems[index].nameTa = nameTa;
                    menuItems[index].priceKg = priceKg;
                    menuItems[index].priceUnit = priceUnit;
                    if (imgData) menuItems[index].img = imgData;
                    
                    if (!inventory[editingItemId]) inventory[editingItemId] = { kg: 0, unit: 0 };
                    
                    if (document.getElementById('in-stock-kg').value !== "") inventory[editingItemId].kg = stockKg;
                    if (document.getElementById('in-stock-unit').value !== "") inventory[editingItemId].unit = stockUnit;
                    
                    showToast("Item Updated!");
                }
            } else {
                const newId = nextId.toString();
                const newItem = {
                    id: newId,
                    nameEn,
                    nameTa: nameTa || nameEn,
                    priceKg,
                    priceUnit,
                    img: imgData
                };
                menuItems.push(newItem);
                inventory[newId] = { kg: stockKg, unit: stockUnit };
                nextId++;
                showToast("Item Created!");
            }

            save();
            renderMenu();
            resetMenuForm();
            renderMenuTableRows();
        }

        function editMenuItem(id) {
            const item = menuItems.find(i => i.id === id);
            const itemInv = inventory[id] || {kg:0, unit:0};
            if(!item) return;

            editingItemId = id;
            
            document.getElementById('form-heading').textContent = `Editing: ${item.nameEn}`;
            document.getElementById('btn-save-item').textContent = "Update Item";
            document.getElementById('btn-save-item').className = "px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded text-sm font-bold shadow-lg";

            document.getElementById('in-name-en').value = item.nameEn;
            document.getElementById('in-name-ta').value = item.nameTa;
            document.getElementById('in-price-kg').value = item.priceKg;
            document.getElementById('in-price-unit').value = item.priceUnit;
            
            document.getElementById('in-stock-kg').value = itemInv.kg;
            document.getElementById('in-stock-unit').value = itemInv.unit;
            
            document.getElementById('modal-body').scrollTop = 0;
        }

        function deleteMenuItem(id) {
            if(!confirm("Delete this item permanently? This will NOT affect past sales history, but the item will be gone from the menu.")) return;
            menuItems = menuItems.filter(i => i.id !== id);
            delete inventory[id];
            save();
            renderMenu();
            renderMenuTableRows();
            showToast("Item Deleted.");
        }

        function resetMenuForm() {
            editingItemId = null;
            document.getElementById('form-heading').textContent = "Add New Item";
            document.getElementById('btn-save-item').textContent = "Save Item";
            document.getElementById('btn-save-item').className = "px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded text-sm font-bold shadow-lg";
            
            document.getElementById('in-name-en').value = '';
            document.getElementById('in-name-ta').value = '';
            document.getElementById('in-price-kg').value = '';
            document.getElementById('in-price-unit').value = '';
            document.getElementById('in-stock-kg').value = '';
            document.getElementById('in-stock-unit').value = '';
            document.getElementById('in-img').value = '';
        }

        // ================= INVENTORY EDITOR (Simple) =================
        function renderInventoryEditor(container) {
            let html = `<div class="overflow-x-auto"><table class="w-full text-sm text-left">
                <thead class="bg-gray-100 text-xs uppercase"><tr><th class="p-3">Item</th><th class="p-3">Stock (Kg)</th><th class="p-3">Stock (Units)</th></tr></thead>
                <tbody class="divide-y">`;
            
            menuItems.forEach(i => {
                const inv = inventory[i.id] || {kg:0, unit:0};
                html += `
                <tr>
                    <td class="p-3 font-medium">${i.nameEn}</td>
                    <td class="p-3">
                        <div class="flex items-center">
                            <button onclick="updateStock('${i.id}','kg',-1)" class="w-8 h-8 bg-gray-200 rounded hover:bg-gray-300 font-bold">-</button>
                            <input type="number" class="w-16 text-center mx-1 border rounded h-8" value="${inv.kg.toFixed(2)}" onchange="setStock('${i.id}','kg',this.value)">
                            <button onclick="updateStock('${i.id}','kg',1)" class="w-8 h-8 bg-gray-200 rounded hover:bg-gray-300 font-bold">+</button>
                        </div>
                        <div class="text-xs text-gray-400 mt-1 ml-1">= ${(inv.kg*1000).toFixed(0)} g</div>
                    </td>
                    <td class="p-3">
                        <div class="flex items-center">
                            <button onclick="updateStock('${i.id}','unit',-1)" class="w-8 h-8 bg-gray-200 rounded hover:bg-gray-300 font-bold">-</button>
                            <input type="number" class="w-16 text-center mx-1 border rounded h-8" value="${inv.unit}" onchange="setStock('${i.id}','unit',this.value)">
                            <button onclick="updateStock('${i.id}','unit',1)" class="w-8 h-8 bg-gray-200 rounded hover:bg-gray-300 font-bold">+</button>
                        </div>
                    </td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }

        function updateStock(id, type, delta) {
            if(!inventory[id]) inventory[id] = {kg:0, unit:0};
            if (type === 'kg') {
                inventory[id][type] = Math.max(0, inventory[id][type] + delta);
            } else { // unit
                inventory[id][type] = Math.max(0, inventory[id][type] + delta);
            }
            save();
            renderInventoryEditor(document.getElementById('modal-body'));
        }
        function setStock(id, type, val) {
            if(!inventory[id]) inventory[id] = {kg:0, unit:0};
            inventory[id][type] = parseFloat(val) || 0;
            save();
            renderInventoryEditor(document.getElementById('modal-body'));
        }

        // ================= MAIN UI RENDER =================
        function renderMenu() {
            const container = document.getElementById('product-menu');
            container.innerHTML = '';
            
            const lang = document.getElementById('lang-switch').value;
            const isTa = lang === 'ta' || (lang==='auto' && navigator.language.startsWith('ta'));

            menuItems.forEach(item => {
                let options = '';
                
                if (item.priceKg > 0) {
                    options += `<option value="kg">Kg (${formatCurrency(item.priceKg)})</option><option value="g">Grams</option>`;
                }
                if (item.priceUnit > 0) {
                    options += `<option value="unit">Piece (${formatCurrency(item.priceUnit)})</option>`;
                }
                if (!options) return;

                const displayName = isTa ? item.nameTa : item.nameEn;
                const subName = isTa ? item.nameEn : item.nameTa;
                
                const stock = inventory[item.id] || {kg:0, unit:0};
                let badge = '';
                if(stock.kg < 1 && stock.unit < 5) badge = `<span class="absolute top-2 right-2 bg-red-500 text-white text-[10px] px-2 py-1 rounded-full shadow z-10 font-bold">LOW STOCK</span>`;

                const imgContent = item.img 
                    ? `<img src="${item.img}" class="w-full h-full object-cover">`
                    : `<div class="w-full h-full bg-green-50 flex items-center justify-center text-4xl">ü•¶</div>`;

                const card = document.createElement('div');
                card.className = "bg-white rounded-xl shadow-sm hover:shadow-lg transition-all border border-gray-100 relative flex flex-col overflow-hidden group";
                card.innerHTML = `
                    ${badge}
                    <div class="h-32 w-full relative">
                        ${imgContent}
                        <div class="absolute bottom-0 w-full bg-gradient-to-t from-black/60 to-transparent p-2">
                             <h3 class="font-bold text-white text-lg leading-none drop-shadow-md">${displayName}</h3>
                             <p class="text-xs text-gray-200 drop-shadow">${subName}</p>
                        </div>
                    </div>
                    <div class="p-3 flex flex-col gap-2 bg-white">
                        <div class="flex gap-2">
                            <select id="u-${item.id}" class="bg-gray-50 border border-gray-200 text-sm rounded w-2/3 p-1 outline-none focus:border-green-500">${options}</select>
                            <input id="q-${item.id}" type="number" value="1" class="border border-gray-200 rounded w-1/3 text-center p-1 outline-none focus:border-green-500" min="0.01">
                        </div>
                        <button onclick="addToCart('${item.id}')" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded text-sm transition-colors shadow-sm">ADD TO BILL</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        document.getElementById('lang-switch').addEventListener('change', renderMenu);


        // ================= CART LOGIC (Auto Conversion) =================
        function addToCart(id) {
            const item = menuItems.find(i => i.id === id);
            if (!item) return;

            const unitSelect = document.getElementById(`u-${id}`);
            const qtyInput = document.getElementById(`q-${id}`);
            const unit = unitSelect.value;
            const qty = parseFloat(qtyInput.value);

            if(isNaN(qty) || qty <= 0) { showToast("Invalid Quantity", 'error'); return; }

            const inv = inventory[id] || {kg: 0, unit: 0};
            let avail = 0;
            let req = 0;
            let pricePer = 0;
            let label = '';
            
            if(unit === 'unit') {
                avail = inv.unit;
                req = qty;
                pricePer = item.priceUnit;
                label = `${qty} Pcs`;
                if(req > avail) { showToast(`Only ${avail} units left in stock`, 'error'); return; }
            } else {
                avail = inv.kg; // Available stock in Kilograms
                pricePer = item.priceKg;
                if (unit === 'g') {
                    req = qty / 1000; // Required amount in Kilograms
                    label = `${qty} g`;
                } else { // 'kg'
                    req = qty; // Required amount in Kilograms
                    label = `${qty} Kg`;
                }
                
                if(req > avail) { showToast(`Only ${(avail * 1000).toFixed(0)} grams (${avail.toFixed(2)} Kg) left`, 'error'); return; }
            }

            // Calculate Price
            const price = pricePer * (unit === 'unit' ? qty : req);

            // Check if item with same unit already in cart
            const existingItemIndex = cart.findIndex(c => c.id === id && c.unit === unit);

            if (existingItemIndex !== -1) {
                cart[existingItemIndex].qty += qty;
                cart[existingItemIndex].reqKgUnit += (unit === 'unit' ? qty : req); // total units/kg requested
                cart[existingItemIndex].subtotal += price;
            } else {
                cart.push({
                    id,
                    name: item.nameEn,
                    qty: qty, // User entered quantity (e.g., 500 for grams, 2 for kg)
                    reqKgUnit: (unit === 'unit' ? qty : req), // Quantity used for deduction/price calculation (e.g., 0.5 for grams, 2 for kg/unit)
                    unit,
                    pricePer,
                    subtotal: price,
                    label 
                });
            }

            qtyInput.value = 1; // Reset quantity input
            showToast(`${item.nameEn} added to bill!`);
            renderCart();
        }

        function updateCartItem(index, newQty) {
            if (newQty <= 0) {
                cart.splice(index, 1);
                showToast("Item removed from cart.", 'warning');
            } else {
                const cartItem = cart[index];
                const item = menuItems.find(i => i.id === cartItem.id);
                if (!item) return;

                const diffQty = newQty - cartItem.qty;
                const inv = inventory[cartItem.id] || {kg: 0, unit: 0};
                let currentReq = 0;
                let pricePer = 0;

                if (cartItem.unit === 'unit') {
                    currentReq = newQty;
                    pricePer = item.priceUnit;
                    if (currentReq > inv.unit) { showToast(`Cannot add. Only ${inv.unit} units available.`, 'error'); return; }
                } else { // kg or g
                    pricePer = item.priceKg;
                    const newReqKg = (cartItem.unit === 'g' ? newQty / 1000 : newQty);
                    if (newReqKg > inv.kg + (cartItem.unit === 'g' ? cartItem.qty/1000 : cartItem.qty)) { 
                        showToast(`Cannot add. Only ${(inv.kg*1000).toFixed(0)} grams available.`, 'error'); 
                        return; 
                    }
                    cartItem.reqKgUnit = newReqKg;
                }
                
                cartItem.qty = newQty;
                cartItem.subtotal = pricePer * cartItem.reqKgUnit;
                cartItem.label = cartItem.unit === 'unit' ? `${newQty} Pcs` : (cartItem.unit === 'kg' ? `${newQty} Kg` : `${newQty} g`);

            }
            renderCart();
        }

        function renderCart() {
            const list = document.getElementById('cart-list');
            list.innerHTML = '';
            let total = 0;

            if (cart.length === 0) {
                list.innerHTML = `<div class="text-center text-gray-400 text-sm mt-10">Cart is empty</div>`;
                document.getElementById('cart-total').textContent = formatCurrency(0);
                return;
            }

            cart.forEach((item, index) => {
                total += item.subtotal;
                const cartItemDiv = document.createElement('div');
                cartItemDiv.className = "flex justify-between items-center bg-gray-50 p-3 rounded-lg border";
                cartItemDiv.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <p class="font-bold text-gray-800 truncate">${getDisplayName(menuItems.find(i => i.id === item.id))}</p>
                        <p class="text-xs text-gray-500">${item.label} @ ${formatCurrency(item.pricePer)}/${item.unit === 'unit' ? 'Pc' : 'Kg'}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="number" 
                               value="${item.qty}" 
                               min="${item.unit === 'g' ? 1 : 0.01}" 
                               step="${item.unit === 'g' ? 1 : 0.01}"
                               onchange="updateCartItem(${index}, parseFloat(this.value))" 
                               class="w-16 text-center border rounded p-1 text-sm">
                        <span class="font-bold text-green-700 w-20 text-right">${formatCurrency(item.subtotal)}</span>
                        <button onclick="updateCartItem(${index}, 0)" class="text-red-500 hover:text-red-700 text-lg leading-none">&times;</button>
                    </div>
                `;
                list.appendChild(cartItemDiv);
            });

            document.getElementById('cart-total').textContent = formatCurrency(total);
        }

        function clearCart() {
            if (cart.length > 0 && confirm("Clear all items from the cart?")) {
                cart = [];
                renderCart();
                showToast("Cart cleared.", 'warning');
            }
        }
        
        // ================= PAYMENT & SALE FINALIZATION =================
        function openPaymentModal() {
            if (cart.length === 0) {
                showToast("Cart is empty!", 'error');
                return;
            }
            const total = cart.reduce((sum, item) => sum + item.subtotal, 0);
            
            document.getElementById('pay-amount').textContent = formatCurrency(total);
            document.getElementById('payment-modal').classList.remove('hidden');
            
            const payQrImg = document.getElementById('pay-qr-img');
            const payQrErr = document.getElementById('pay-qr-err');
            if (qrCode) {
                payQrImg.src = qrCode;
                payQrImg.classList.remove('hidden');
                payQrErr.classList.add('hidden');
            } else {
                payQrImg.classList.add('hidden');
                payQrErr.classList.remove('hidden');
            }
            
            document.getElementById('payment-mode').addEventListener('change', (e) => {
                document.getElementById('qr-area').classList.toggle('hidden', e.target.value !== 'upi');
            });
            document.getElementById('qr-area').classList.toggle('hidden', document.getElementById('payment-mode').value !== 'upi');
        }

        function finishSale() {
            const total = cart.reduce((sum, item) => sum + item.subtotal, 0);
            const mode = document.getElementById('payment-mode').value;
            
            if (total === 0) {
                showToast("Sale amount is zero!", 'error');
                closePaymentModal();
                return;
            }
            
            // 1. Deduct Stock
            cart.forEach(item => {
                if(!inventory[item.id]) inventory[item.id] = {kg: 0, unit: 0};
                
                if (item.unit === 'unit') {
                    inventory[item.id].unit = Math.max(0, inventory[item.id].unit - item.reqKgUnit);
                } else { // kg or g
                    inventory[item.id].kg = Math.max(0, inventory[item.id].kg - item.reqKgUnit);
                }
            });

            // 2. Log Sale
            const sale = {
                id: Date.now().toString(),
                timestamp: new Date().toISOString(),
                items: JSON.parse(JSON.stringify(cart)), // Deep copy of cart
                total: total,
                mode: mode
            };
            salesHistory.push(sale);

            // 3. Save, Clear, & Notify
            save();
            const receiptCart = JSON.parse(JSON.stringify(cart)); // Get items before clearing
            cart = [];
            renderCart();
            renderMenu(); // Update low stock badges
            
            closePaymentModal();
            showToast(`Sale completed! Total: ${formatCurrency(total)}`, 'success');
            
            // Optional: Auto print receipt
            printBill(receiptCart, sale.id, sale.timestamp, sale.mode, total);
        }

        // ================= PRINT RECEIPT (BILINGUAL) =================
        function printBill(finalCart = cart, saleId = 'DRAFT', timestamp = new Date().toISOString(), mode = 'N/A', total = cart.reduce((sum, item) => sum + item.subtotal, 0)) {
            if (finalCart.length === 0) {
                showToast("No items to print.", 'error');
                return;
            }

            const printArea = document.createElement('div');
            printArea.className = 'printable-bill-area';
            
            const findItem = (id) => menuItems.find(i => i.id === id);

            let itemsHtml = finalCart.map(item => {
                const product = findItem(item.id);
                const nameEn = product?.nameEn || item.name;
                const nameTa = product?.nameTa || nameEn;
                
                return `
                    <div class="flex justify-between">
                        <span class="w-1/2">${nameEn} (${nameTa})</span>
                        <span class="w-1/4 text-center">${item.label}</span>
                        <span class="w-1/4 text-right">${formatCurrency(item.subtotal)}</span>
                    </div>
                `;
            }).join('');

            printArea.innerHTML = `
                <div class="text-center">
                    <h1 class="text-lg font-bold">V S TRADERS (‡Æµ‡Æø ‡Æé‡Æ∏‡Øç ‡Æü‡Æø‡Æ∞‡Øá‡Æü‡Æ∞‡Øç‡Æ∏‡Øç)</h1>
                    <p class="text-[10px]">Your kangayam, Tiruppur, Tamil Nadu (‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡ÆÆ‡ØÅ‡Æï‡Æµ‡Æ∞‡Æø)</p>
                    <p class="text-[10px]">GSTIN: VS TRADERS</p>
                    <p class="text-[10px]">Ph: 9999999999 | ${new Date(timestamp).toLocaleDateString()} (${new Date(timestamp).toLocaleTimeString()})</p>
                    <p class="text-[10px] font-bold">Bill ID: ${saleId}</p>
                </div>
                <hr class="border-t border-dashed my-1">
                <div class="flex font-bold text-[11px]">
                    <span class="w-1/2">Item / ‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Øç</span>
                    <span class="w-1/4 text-center">Qty / ‡ÆÖ‡Æ≥‡Æµ‡ØÅ</span>
                    <span class="w-1/4 text-right">Amt / ‡Æ§‡Øä‡Æï‡Øà</span>
                </div>
                <hr class="border-t border-dashed my-1">
                ${itemsHtml}
                <hr class="border-t border-dashed my-1">
                <div class="flex justify-between font-bold text-md mt-1">
                    <span>TOTAL / ‡ÆÆ‡Øä‡Æ§‡Øç‡Æ§‡Æ§‡Øç ‡Æ§‡Øä‡Æï‡Øà:</span>
                    <span>${formatCurrency(total)}</span>
                </div>
                <p class="text-[10px] mt-1">Paid By / ‡Æ™‡Æ£‡ÆÆ‡Øç ‡Æö‡ØÜ‡Æ≤‡ØÅ‡Æ§‡Øç‡Æ§‡Æø‡ÆØ ‡ÆÆ‡ØÅ‡Æ±‡Øà: ${mode.toUpperCase()}</p>
                <hr class="border-t border-dashed my-1">
                <p class="text-center text-[10px] font-bold">Thank You! Visit Again! (‡Æ®‡Æ©‡Øç‡Æ±‡Æø! ‡ÆÆ‡ØÄ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æµ‡Æ∞‡ØÅ‡Æï!)</p>
            `;

            // Append to body and immediately print
            document.body.appendChild(printArea);
            window.print();
            
            // Cleanup
            document.body.removeChild(printArea);
        }


        // ================= REPORTS =================
        function openReportsModal() {
            const modal = document.getElementById('generic-modal');
            const body = document.getElementById('modal-body');
            const title = document.getElementById('modal-title');
            
            modal.classList.remove('hidden'); modal.classList.add('flex');
            title.textContent = "Sales & Inventory Reports";

            body.innerHTML = `
                <div class="space-y-6">
                    <div class="grid grid-cols-3 gap-4">
                        <button onclick="generateReport('daily')" class="bg-blue-600 text-white p-4 rounded-lg shadow hover:bg-blue-700">Daily Sales</button>
                        <button onclick="generateReport('monthly')" class="bg-indigo-600 text-white p-4 rounded-lg shadow hover:bg-indigo-700">Monthly Sales</button>
                        <button onclick="generateReport('stock')" class="bg-yellow-600 text-white p-4 rounded-lg shadow hover:bg-yellow-700">Low Stock Report</button>
                        <button onclick="generateReport('detailed-stock')" class="bg-green-600 text-white p-4 rounded-lg shadow hover:bg-green-700 col-span-3">Full Stock & Valuation Report</button>
                    </div>
                    
                    <div id="report-output-preview" class="p-4 bg-gray-50 border rounded-lg max-h-96 overflow-y-auto">
                        <p class="text-gray-500 text-center">Select a report type above to generate a preview.</p>
                    </div>

                </div>
            `;
        }

        function generateReport(type) {
            const preview = document.getElementById('report-output-preview');
            let reportTitle = '';
            let reportHtml = '';

            const data = salesHistory.filter(s => s.total > 0);

            if (type === 'daily') {
                reportTitle = `Daily Sales Report: ${new Date().toLocaleDateString()}`;
                const dailyData = data.filter(s => new Date(s.timestamp).toDateString() === new Date().toDateString());
                reportHtml = generateSalesTable(dailyData, 'Sale Breakdown for Today');
            } else if (type === 'monthly') {
                reportTitle = `Monthly Sales Report: ${new Date().toLocaleString('default', { month: 'long', year: 'numeric' })}`;
                const startOfMonth = new Date();
                startOfMonth.setDate(1);
                startOfMonth.setHours(0, 0, 0, 0);
                
                const monthlyData = data.filter(s => new Date(s.timestamp) >= startOfMonth);
                reportHtml = generateSalesSummary(monthlyData, 'Monthly Revenue Summary');
            } else if (type === 'stock') {
                reportTitle = "Low Stock Inventory Report";
                reportHtml = generateLowStockReport();
            } else if (type === 'detailed-stock') {
                reportTitle = "Detailed Current Stock & Valuation Report";
                reportHtml = generateDetailedStockReport();
            }

            preview.innerHTML = reportHtml;
            
            // Set up the full print view
            const printContainer = document.getElementById('report-print-container');
            const printArea = document.getElementById('report-print');
            printArea.innerHTML = `
                <h2 class="text-xl font-bold mb-4 text-center">${reportTitle}</h2>
                ${reportHtml}
                <p class="text-xs text-gray-500 mt-6 text-center">Report Generated: ${new Date().toLocaleString()}</p>
            `;
            printContainer.classList.remove('hidden');
            closeGenericModal();
        }

        function generateSalesTable(salesData, subtitle) {
            let totalRevenue = 0;
            let totalCash = 0;
            let totalUpi = 0;

            const rows = salesData.map(sale => {
                totalRevenue += sale.total;
                if (sale.mode === 'cash') totalCash += sale.total;
                if (sale.mode === 'upi') totalUpi += sale.total;
                
                const time = new Date(sale.timestamp).toLocaleTimeString();
                const itemsList = sale.items.map(i => `${i.name} (${i.label})`).join(', ');

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="p-2">${time}</td>
                        <td class="p-2">${itemsList}</td>
                        <td class="p-2 text-right">${formatCurrency(sale.total)}</td>
                        <td class="p-2 text-center text-xs uppercase">${sale.mode}</td>
                    </tr>
                `;
            }).join('');

            return `
                <h3 class="font-bold text-lg mb-2">${subtitle}</h3>
                <div class="flex justify-around mb-4 p-3 bg-green-100 rounded-lg">
                    <p class="font-bold text-green-800">Total Revenue: ${formatCurrency(totalRevenue)}</p>
                    <p class="text-blue-800">Cash: ${formatCurrency(totalCash)}</p>
                    <p class="text-purple-800">UPI: ${formatCurrency(totalUpi)}</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm text-left border rounded-lg">
                        <thead class="bg-gray-200 text-xs uppercase">
                            <tr>
                                <th class="p-2">Time</th>
                                <th class="p-2">Items</th>
                                <th class="p-2 text-right">Amount</th>
                                <th class="p-2 text-center">Mode</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">${rows}</tbody>
                    </table>
                </div>
            `;
        }
        
        function generateSalesSummary(salesData, subtitle) {
            const summary = salesData.reduce((acc, sale) => {
                const dateKey = new Date(sale.timestamp).toLocaleDateString();
                if (!acc[dateKey]) {
                    acc[dateKey] = { total: 0, cash: 0, upi: 0, card: 0 };
                }
                acc[dateKey].total += sale.total;
                acc[dateKey][sale.mode] = (acc[dateKey][sale.mode] || 0) + sale.total;
                return acc;
            }, {});

            let totalRevenue = 0;
            const rows = Object.keys(summary).sort((a, b) => new Date(a) - new Date(b)).map(dateKey => {
                const daySummary = summary[dateKey];
                totalRevenue += daySummary.total;
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="p-2 font-medium">${dateKey}</td>
                        <td class="p-2 text-right font-bold">${formatCurrency(daySummary.total)}</td>
                        <td class="p-2 text-right">${formatCurrency(daySummary.cash)}</td>
                        <td class="p-2 text-right">${formatCurrency(daySummary.upi)}</td>
                        <td class="p-2 text-right">${formatCurrency(daySummary.card)}</td>
                    </tr>
                `;
            }).join('');
            
            return `
                <h3 class="font-bold text-lg mb-2">${subtitle}</h3>
                <div class="text-xl font-bold text-center p-3 mb-4 bg-indigo-100 rounded-lg">Total Monthly Revenue: ${formatCurrency(totalRevenue)}</div>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm text-left border rounded-lg">
                        <thead class="bg-gray-200 text-xs uppercase">
                            <tr>
                                <th class="p-2">Date</th>
                                <th class="p-2 text-right">Total</th>
                                <th class="p-2 text-right">Cash</th>
                                <th class="p-2 text-right">UPI</th>
                                <th class="p-2 text-right">Card</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">${rows}</tbody>
                    </table>
                </div>
            `;
        }
        
        function generateLowStockReport() {
            const lowStockThresholdKg = 1; // 1 Kg
            const lowStockThresholdUnit = 5; // 5 Units
            
            const lowStockItems = menuItems.filter(item => {
                const inv = inventory[item.id] || {kg: 0, unit: 0};
                return (inv.kg > 0 && inv.kg < lowStockThresholdKg) || 
                       (inv.unit > 0 && inv.unit < lowStockThresholdUnit);
            });
            
            if (lowStockItems.length === 0) {
                return `<p class="text-green-600 text-center p-4">‚úÖ All items are above the low stock threshold.</p>`;
            }

            const rows = lowStockItems.map(item => {
                const inv = inventory[item.id] || {kg: 0, unit: 0};
                const kgStatus = inv.kg < lowStockThresholdKg && item.priceKg > 0 ? `<span class="bg-red-200 text-red-800 p-1 rounded text-xs">${inv.kg.toFixed(2)} Kg</span>` : `${inv.kg.toFixed(2)} Kg`;
                const unitStatus = inv.unit < lowStockThresholdUnit && item.priceUnit > 0 ? `<span class="bg-red-200 text-red-800 p-1 rounded text-xs">${inv.unit} Units</span>` : `${inv.unit} Units`;
                
                return `
                    <tr class="hover:bg-red-50">
                        <td class="p-2 font-medium">${item.nameEn}</td>
                        <td class="p-2">${item.nameTa}</td>
                        <td class="p-2 text-center">${kgStatus}</td>
                        <td class="p-2 text-center">${unitStatus}</td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm text-left border rounded-lg">
                        <thead class="bg-yellow-200 text-xs uppercase">
                            <tr>
                                <th class="p-2">Item (En)</th>
                                <th class="p-2">Item (Ta)</th>
                                <th class="p-2 text-center">Kg Stock</th>
                                <th class="p-2 text-center">Unit Stock</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">${rows}</tbody>
                    </table>
                </div>
                <p class="text-xs text-gray-500 mt-2">Threshold: < 1 Kg or < 5 Units.</p>
            `;
        }

        function generateDetailedStockReport() {
            let totalStockValue = 0;

            const rows = menuItems.map(item => {
                const inv = inventory[item.id] || { kg: 0, unit: 0 };
                
                // Calculate stock value for Kg (if applicable)
                const kgStock = inv.kg || 0;
                const kgPrice = item.priceKg || 0;
                const kgValue = kgStock * kgPrice;
                
                // Calculate stock value for Units (if applicable)
                const unitStock = inv.unit || 0;
                const unitPrice = item.priceUnit || 0;
                const unitValue = unitStock * unitPrice;

                const totalItemValue = kgValue + unitValue;
                totalStockValue += totalItemValue;

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="p-2 font-medium">${item.nameEn}<div class="text-xs text-gray-500">${item.nameTa}</div></td>
                        <td class="p-2 text-right">${kgPrice > 0 ? formatCurrency(kgPrice) : '-'}</td>
                        <td class="p-2 text-right">${kgPrice > 0 ? kgStock.toFixed(2) + ' Kg' : '-'}</td>
                        <td class="p-2 text-right text-green-700 font-bold">${kgPrice > 0 ? formatCurrency(kgValue) : '-'}</td>
                        
                        <td class="p-2 text-right">${unitPrice > 0 ? formatCurrency(unitPrice) : '-'}</td>
                        <td class="p-2 text-right">${unitPrice > 0 ? unitStock + ' Pcs' : '-'}</td>
                        <td class="p-2 text-right text-blue-700 font-bold">${unitPrice > 0 ? formatCurrency(unitValue) : '-'}</td>

                        <td class="p-2 text-right bg-gray-100 font-extrabold text-lg">${formatCurrency(totalItemValue)}</td>
                    </tr>
                `;
            }).join('');

            return `
                <h3 class="font-bold text-lg mb-2">Inventory Breakdown and Valuation (Selling Price)</h3>
                <div class="text-2xl font-bold text-center p-4 mb-4 bg-green-100 rounded-lg border border-green-300">
                    Total Estimated Inventory Value (Selling Price): <span class="text-green-800">${formatCurrency(totalStockValue)}</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm text-left border rounded-lg">
                        <thead class="bg-gray-200 text-xs uppercase">
                            <tr>
                                <th class="p-2" rowspan="2">Item Name</th>
                                <th class="p-2 text-center" colspan="3">Kilogram (Kg) Stock</th>
                                <th class="p-2 text-center" colspan="3">Unit (Pcs) Stock</th>
                                <th class="p-2 text-center" rowspan="2">Total Item Value</th>
                            </tr>
                            <tr class="bg-gray-300 text-xs uppercase">
                                <th class="p-2 text-right">Price/Kg</th>
                                <th class="p-2 text-right">Qty (Kg)</th>
                                <th class="p-2 text-right">Value (Kg)</th>
                                <th class="p-2 text-right">Price/Pc</th>
                                <th class="p-2 text-right">Qty (Pcs)</th>
                                <th class="p-2 text-right">Value (Pcs)</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">${rows}</tbody>
                        <tfoot class="bg-gray-200 font-bold">
                            <tr>
                                <td class="p-2 text-right" colspan="7">GRAND TOTAL (Selling Price)</td>
                                <td class="p-2 text-right text-xl text-green-800">${formatCurrency(totalStockValue)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
        }
        
        // ================= PDF GENERATION =================
        function generateReportPdf() {
            const { jsPDF } = window.jspdf;
            const element = document.getElementById('report-print');
            const title = element.querySelector('h2').textContent;

            html2canvas(element, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/jpeg', 0.9);
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 210; 
                const pageHeight = 295;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                pdf.save(`${title.replace(/[^a-z0-9]/gi, '_')}.pdf`);
                showToast("PDF report generated.");
            }).catch(error => {
                console.error("PDF generation failed:", error);
                showToast("Failed to generate PDF.", 'error');
            });
        }
        
        // Initialize the app when the DOM is ready
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

