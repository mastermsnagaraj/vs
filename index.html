<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V S TRADERS - Vegetable Store POS</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for print output */
        @media print {
            body * {
                visibility: hidden;
            }
            .printable-area, .printable-area * {
                visibility: visible;
            }
            .printable-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                font-family: monospace;
            }
            /* Hide the print preview for the actual app UI */
            #app-container { display: none !important; }
            #report-container { display: block !important; }
        }
        /* Inter font for better readability */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f7f9fc;
        }
        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #4CAF50;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #e0f2f1;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Main Application Container -->
    <div id="app-container" class="flex flex-1 flex-col lg:flex-row">
        
        <!-- Header for Mobile/Tablet -->
        <header class="lg:hidden bg-green-700 text-white p-4 shadow-lg sticky top-0 z-10">
            <h1 class="text-xl font-bold">V S TRADERS</h1>
            <p id="user-id-display-mobile" class="text-xs mt-1 opacity-75">Session ID</p>
        </header>

        <!-- Product Menu (Left/Top) -->
        <main class="lg:w-3/5 xl:w-2/3 p-4 custom-scrollbar overflow-y-auto">
            <h2 class="text-2xl font-extrabold mb-2 text-gray-800 hidden lg:block">Available Vegetables</h2>
            <div class="flex items-center justify-end mb-4">
                <label for="lang-switch" class="text-sm text-gray-700 mr-2">Language</label>
                <select id="lang-switch" class="border border-gray-300 rounded-lg p-1 text-sm">
                    <option value="auto">Auto</option>
                    <option value="en">English</option>
                    <option value="ta">தமிழ்</option>
                </select>
            </div>
            <div id="product-menu" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                <!-- Product cards will be rendered here -->
            </div>
        </main>

        <!-- Cart and Billing (Right/Bottom) -->
        <aside class="lg:w-2/5 xl:w-1/3 bg-white border-l border-gray-200 shadow-xl flex flex-col">
            <!-- Header for Desktop -->
            <header class="p-4 bg-green-800 text-white hidden lg:block">
                <h1 class="text-2xl font-extrabold">V S TRADERS</h1>
                <p id="user-id-display-desktop" class="text-sm mt-1 opacity-75">Session ID</p>
            </header>

            <!-- Cart Items -->
            <div id="cart-items-container" class="flex-1 overflow-y-auto p-4 custom-scrollbar border-b border-gray-200">
                <h3 class="text-xl font-semibold mb-3 text-gray-700">Billing Cart (பில் பட்டியல்)</h3>
                <div id="cart-list" class="space-y-3">
                    <p class="text-gray-500 text-sm">Add items from the menu to start billing.</p>
                </div>
            </div>

            <!-- Totals and Actions -->
            <div class="p-4 bg-gray-50 shadow-inner">
                <div class="flex justify-between items-center mb-3 font-bold text-lg text-gray-800">
                    <span>Total (மொத்தம்):</span>
                    <span id="cart-total" class="text-2xl text-green-600">₹0.00</span>
                </div>

                <div class="space-y-3">
                    <button onclick="openPaymentModal()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-md">
                        Pay Now (பணம் செலுத்து)
                    </button>
                    <div class="flex space-x-3">
                        <button onclick="printBill()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                            Print Bill (பில் அச்சிடு)
                        </button>
                        <button onclick="shareBill()" class="flex-1 bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                            Share (பகிர்)
                        </button>
                    </div>
                    <button onclick="clearCart()" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 text-sm">
                        Clear Cart (பட்டியலை அழி)
                    </button>
                </div>
            </div>
        </aside>
    </div>

    <!-- Management/Report Buttons (Fixed Bottom on Mobile, Top Right on Desktop) -->
    <div class="fixed bottom-0 left-0 right-0 lg:static lg:p-4 lg:flex lg:justify-end bg-white lg:bg-transparent p-3 border-t lg:border-t-0 shadow-2xl lg:shadow-none z-20">
        <div class="flex justify-around lg:space-x-4 space-x-2">
            <button onclick="openManagerModal('menu')" class="flex-1 lg:flex-none text-sm bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-3 rounded-lg transition duration-200 shadow-md">
                Manage Menu (மெனுவை நிர்வகி)
            </button>
            <button onclick="openManagerModal('inventory')" class="flex-1 lg:flex-none text-sm bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-3 rounded-lg transition duration-200 shadow-md">
                Manage Stock (பங்கு நிர்வகி)
            </button>
            <button onclick="openReportsModal()" class="flex-1 lg:flex-none text-sm bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded-lg transition duration-200 shadow-md">
                Reports (அறிக்கைகள்)
            </button>
            <button onclick="openQrUploadModal()" class="flex-1 lg:flex-none text-sm bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-3 rounded-lg transition duration-200 shadow-md">
                QR Code (QR குறியீடு)
            </button>
        </div>
    </div>


    <!-- ==================================== MODALS ==================================== -->

    <!-- Generic Modal Structure -->
    <div id="generic-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center p-4" onclick="closeModal(event)">
        <div id="modal-content-area" class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto transform transition-all duration-300 scale-95" onclick="event.stopPropagation()">
            <div class="p-6">
                <h3 id="modal-title" class="text-2xl font-bold mb-4 border-b pb-2 text-gray-800">Modal Title</h3>
                <div id="modal-body">
                    <!-- Dynamic content will be loaded here -->
                </div>
                <div class="mt-6 flex justify-end">
                    <button onclick="document.getElementById('generic-modal').classList.add('hidden'); document.getElementById('generic-modal').classList.remove('flex');" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-200">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Upload Modal -->
    <div id="qr-upload-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center p-4" onclick="closeModal(event)">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold mb-4 border-b pb-2 text-gray-800">QR Code Upload (QR குறியீடு பதிவேற்று)</h3>
            <p class="text-sm text-gray-600 mb-4">Upload a payment QR code image. This will be shown on the 'Pay Now' screen.</p>
            <div class="mb-4">
                <input type="file" id="qr-file-input" accept="image/*" class="w-full text-gray-700 border border-gray-300 rounded-lg p-2 focus:ring-green-500 focus:border-green-500">
            </div>
            <div id="qr-preview-container" class="mb-4 flex justify-center border-dashed border-2 border-gray-300 rounded-lg p-4">
                <img id="qr-image-preview" src="" alt="QR Code Preview" class="max-w-full max-h-48 object-contain" style="display:none;">
                <p id="qr-placeholder" class="text-gray-500">No QR Code uploaded yet.</p>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="saveQrCode()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    Save QR Code
                </button>
                <button onclick="document.getElementById('qr-upload-modal').classList.add('hidden'); document.getElementById('qr-upload-modal').classList.remove('flex');" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-200">
                    Close
                </button>
            </div>
            <p id="qr-upload-message" class="mt-4 text-center text-sm text-red-500"></p>
        </div>
    </div>

    <!-- Payment Modal (Hidden) -->
    <div id="payment-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center p-4" onclick="closeModal(event)">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold mb-4 border-b pb-2 text-gray-800">Payment (பணம் செலுத்துதல்)</h3>
            <div class="mb-4">
                <label for="payment-mode" class="block text-sm font-medium text-gray-700 mb-2">Payment Mode (பணம் செலுத்தும் முறை)</label>
                <select id="payment-mode" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-green-500 focus:border-green-500">
                    <option value="cash">Cash (பணம்)</option>
                    <option value="upi">UPI/QR</option>
                    <option value="card">Card (அட்டை)</option>
                </select>
            </div>
            <div id="qr-display-area" class="text-center p-4 border border-gray-300 rounded-lg bg-gray-50 mb-4 hidden">
                <p class="text-lg font-semibold mb-2">Scan to Pay (ஸ்கேன் செய்து பணம் செலுத்துங்கள்)</p>
                <img id="payment-qr-image" src="" alt="Payment QR Code" class="w-48 h-48 mx-auto object-contain mb-3 border rounded-lg">
                <p id="qr-error-message" class="text-red-500 text-sm hidden">QR Code not uploaded. Please upload it in the 'QR Code' manager.</p>
            </div>
            <div class="text-2xl font-extrabold text-center py-4 bg-green-100 rounded-lg">
                Amount Due: <span id="payment-due-amount" class="text-green-600">₹0.00</span>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="completeTransaction()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                    Complete Sale
                </button>
                <button onclick="document.getElementById('payment-modal').classList.add('hidden'); document.getElementById('payment-modal').classList.remove('flex');" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-200">
                    Cancel
                </button>
            </div>
        </div>
    </div>


    <!-- Report Print Area (Hidden, visible only for printing) -->
    <div id="report-container" class="printable-area hidden p-4">
        <div id="report-content"></div>
    </div>

    <!-- Toast Notification Area -->
    <div id="toast-container" class="fixed bottom-4 right-4 space-y-2 z-50">
        <!-- Toasts will be appended here -->
    </div>


    <script>
        // ==================================== GLOBAL STATE & CONFIG (IN-MEMORY) ====================================
        
        // Mock data structures, all data is temporary!
        let menuItems = [
            { id: 'item1', nameEn: 'Onion', nameTa: 'வெங்காயம்', priceKg: 50.00, priceUnit: 5.00 },
            { id: 'item2', nameEn: 'Tomato', nameTa: 'தக்காளி', priceKg: 40.00, priceUnit: 4.00 },
            { id: 'item3', nameEn: 'Potato', nameTa: 'உருளைக்கிழங்கு', priceKg: 35.00, priceUnit: 6.00 },
            { id: 'item4', nameEn: 'Carrot', nameTa: 'கேரட்', priceKg: 70.00, priceUnit: 8.00 },
            { id: 'item5', nameEn: 'Cabbage', nameTa: 'முட்டைக்கோஸ்', priceKg: 30.00, priceUnit: 10.00 },
            { id: 'item6', nameEn: 'Beans', nameTa: 'பீன்ஸ்', priceKg: 80.00, priceUnit: 0.00 },
        ];
        
        // Stock: {itemId: {stockKg: number, stockUnits: number}}
        let inventory = {
            'item1': { stockKg: 10.5, stockUnits: 50 },
            'item2': { stockKg: 15.0, stockUnits: 75 },
            'item3': { stockKg: 20.0, stockUnits: 60 },
            'item4': { stockKg: 8.2, stockUnits: 40 },
            'item5': { stockKg: 12.0, stockUnits: 15 },
            'item6': { stockKg: 7.5, stockUnits: 0 },
        }; 

        let cart = []; // [{itemId, item (menu item object), quantity, unit, price, pricePerUnit}]
        let salesHistory = []; // Temporary sales log

        let qrCodeBase64 = null;
        let nextItemId = 7; // For generating new unique IDs

        // ==================================== UTILITIES ====================================

        /**
         * Shows a toast notification.
         */
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const color = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const toast = document.createElement('div');
            toast.className = `p-3 rounded-lg text-white font-semibold shadow-lg ${color} transition transform ease-out duration-300 translate-x-full opacity-0 max-w-xs`;
            toast.textContent = message;

            container.appendChild(toast);

            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
                toast.classList.add('translate-x-0', 'opacity-100');
            }, 10);

            // Animate out and remove
            setTimeout(() => {
                toast.classList.remove('translate-x-0', 'opacity-100');
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        /**
         * Closes the generic modal if the click is outside the content area.
         */
        function closeModal(event) {
            if (event.target.id === 'generic-modal' || event.target.id === 'qr-upload-modal' || event.target.id === 'payment-modal') {
                event.target.classList.add('hidden');
                event.target.classList.remove('flex');
            }
        }

        /**
         * Converts a File object to a Base64 string.
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]); // Only data part
                reader.onerror = error => reject(error);
            });
        }

        /**
         * Formats a number to currency string.
         */
        function formatCurrency(amount) {
            // Guard against undefined or null before calling toFixed
            const numericAmount = amount === undefined || amount === null ? 0 : amount;
            return `₹${numericAmount.toFixed(2)}`;
        }

        let currentLang = localStorage.getItem('appLang') || 'auto';
        function browserLang() {
            const l = (navigator.language || 'en').toLowerCase();
            return l.startsWith('ta') ? 'ta' : 'en';
        }
        function resolveLang() {
            return currentLang === 'auto' ? browserLang() : currentLang;
        }
        function getDisplayName(item) {
            return resolveLang() === 'ta' ? item.nameTa : item.nameEn;
        }
        function getSecondaryName(item) {
            return resolveLang() === 'ta' ? item.nameEn : item.nameTa;
        }


        // ==================================== APP INITIALIZATION ====================================

        document.addEventListener('DOMContentLoaded', () => {
            // No Firebase init needed. Simply start rendering.
            renderMenu();
            renderCart();
            showToast("Application loaded. Data is not persistent.", 'error');
            const langSel = document.getElementById('lang-switch');
            if (langSel) {
                langSel.value = currentLang;
                langSel.onchange = (e) => {
                    currentLang = e.target.value;
                    localStorage.setItem('appLang', currentLang);
                    renderMenu();
                };
            }
        });


        // ==================================== QR CODE MANAGEMENT (IN-MEMORY) ====================================

        function openQrUploadModal() {
            document.getElementById('qr-upload-modal').classList.add('flex');
            document.getElementById('qr-upload-modal').classList.remove('hidden');
            
            const preview = document.getElementById('qr-image-preview');
            const placeholder = document.getElementById('qr-placeholder');

            if (qrCodeBase64) {
                preview.src = `data:image/png;base64,${qrCodeBase64}`;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
            } else {
                preview.style.display = 'none';
                placeholder.style.display = 'block';
            }

            document.getElementById('qr-file-input').value = '';
            document.getElementById('qr-upload-message').textContent = '';
        }

        /**
         * Handles the file input and saves the QR code Base64 string to memory.
         */
        async function saveQrCode() {
            const fileInput = document.getElementById('qr-file-input');
            const messageEl = document.getElementById('qr-upload-message');
            
            if (fileInput.files.length === 0) {
                messageEl.textContent = "Please select an image file to upload.";
                return;
            }

            const file = fileInput.files[0];
            messageEl.textContent = "Processing and Saving...";
            messageEl.classList.remove('text-red-500');
            messageEl.classList.add('text-green-600');

            try {
                const base64Data = await fileToBase64(file);
                qrCodeBase64 = base64Data; // Update local state
                
                const preview = document.getElementById('qr-image-preview');
                const placeholder = document.getElementById('qr-placeholder');
                preview.src = `data:image/png;base64,${qrCodeBase64}`;
                preview.style.display = 'block';
                placeholder.style.display = 'none';

                showToast("QR Code uploaded successfully!", 'success');
                messageEl.textContent = "QR Code saved!";
                setTimeout(() => document.getElementById('qr-upload-modal').classList.add('hidden'), 1000);

            } catch (e) {
                console.error("Error saving QR code:", e);
                messageEl.textContent = `Error saving QR code: ${e.message}`;
                messageEl.classList.remove('text-green-600');
                messageEl.classList.add('text-red-500');
                showToast("Failed to save QR Code.", 'error');
            }
        }


        // ==================================== BILLING & CART LOGIC ====================================

        /**
         * Calculates the total cost of the cart.
         */
        function calculateTotal() {
            return cart.reduce((sum, item) => sum + item.price, 0);
        }

        /**
         * Renders the cart items and updates the total.
         */
        function renderCart() {
            const cartList = document.getElementById('cart-list');
            cartList.innerHTML = ''; // Clear existing list
            
            if (cart.length === 0) {
                cartList.innerHTML = '<p class="text-gray-500 text-sm py-4 text-center">No items in cart.</p>';
            } else {
                cart.forEach((item, index) => {
                    const listItem = document.createElement('div');
                    listItem.className = 'flex justify-between items-center bg-gray-100 p-3 rounded-lg shadow-sm';
                    
                    // Display Text
                    const quantityText = item.unit === 'units' 
                        ? `${item.quantity} Unit(s)`
                        : `${item.quantity} ${item.unit}`;
                    
                    const itemDetails = `
                        <div class="flex-1 min-w-0">
                            <p class="font-semibold text-gray-800 truncate">${item.item.nameEn} (${item.item.nameTa})</p>
                            <!-- FIX: Using item.pricePerUnit instead of item.item.pricePerUnit which was undefined -->
                            <p class="text-xs text-gray-500">${quantityText} @ ${formatCurrency(item.pricePerUnit)}/${item.unit}</p>
                        </div>
                        <div class="text-right ml-4">
                            <p class="font-bold text-green-600">${formatCurrency(item.price)}</p>
                        </div>
                        <button onclick="removeFromCart(${index})" class="ml-2 p-1 text-red-500 hover:text-red-700 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                    listItem.innerHTML = itemDetails;
                    cartList.appendChild(listItem);
                });
            }

            document.getElementById('cart-total').textContent = formatCurrency(calculateTotal());
        }

        /**
         * Removes an item from the cart by index.
         */
        function removeFromCart(index) {
            cart.splice(index, 1);
            renderCart();
            showToast("Item removed from cart.", 'error');
        }

        /**
         * Clears the entire cart.
         */
        function clearCart() {
            if (cart.length > 0) {
                cart = [];
                renderCart();
                showToast("Cart cleared!", 'success');
            }
        }

        /**
         * Adds an item to the cart after quantity/unit selection.
         */
        window.addToCart = (itemId) => {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;

            const selectorId = `unit-selector-${itemId}`;
            const unit = document.getElementById(selectorId).value;
            const quantityInput = document.getElementById(`quantity-input-${itemId}`);
            let quantity = parseFloat(quantityInput.value);

            if (isNaN(quantity) || quantity <= 0) {
                showToast("Please enter a valid quantity.", 'error');
                return;
            }

            let pricePerUnit = 0;
            let stockKey = '';
            
            if (unit === 'units') {
                pricePerUnit = item.priceUnit || 0;
                stockKey = 'stockUnits';
            } else if (unit === 'grams') {
                pricePerUnit = (item.priceGram && item.priceGram > 0) ? item.priceGram : ((item.priceKg || 0) / 1000);
                stockKey = 'stockKg';
            } else if (unit === 'kilograms') {
                pricePerUnit = item.priceKg || 0;
                stockKey = 'stockKg';
            }

            // Simple stock check
            if (stockKey) {
                let currentStock = inventory[item.id] ? inventory[item.id][stockKey] || 0 : 0;
                
                // Adjust for grams conversion check
                let quantityToCheck = quantity;
                if (unit === 'grams' && stockKey === 'stockKg') {
                    // Convert grams to Kg for checking against stockKg
                    quantityToCheck = quantity / 1000;
                }

                if (quantityToCheck > currentStock) {
                    const unitDisplay = stockKey === 'stockKg' ? 'Kg' : 'Units';
                    showToast(`Insufficient stock! Only ${currentStock.toFixed(2)} ${unitDisplay} available.`, 'error');
                    quantityInput.value = currentStock > 0 ? (unit === 'grams' ? (currentStock * 1000).toFixed(0) : currentStock) : 1;
                    return;
                }
            }


            const totalItemPrice = quantity * pricePerUnit;

            cart.push({
                itemId: item.id,
                item: item,
                quantity: quantity,
                unit: unit,
                price: totalItemPrice,
                pricePerUnit: pricePerUnit, // Correctly store the calculated unit price here
            });

            quantityInput.value = 1; // Reset quantity input
            renderCart();
            showToast(`${item.nameEn} added to cart! Total: ${formatCurrency(totalItemPrice)}`, 'success');
        }


        // ==================================== TRANSACTION & PRINT/SHARE ====================================

        /**
         * Opens the payment modal.
         */
        function openPaymentModal() {
            if (cart.length === 0) {
                showToast("Cart is empty. Please add items first.", 'error');
                return;
            }

            const total = calculateTotal();
            document.getElementById('payment-due-amount').textContent = formatCurrency(total);
            document.getElementById('payment-modal').classList.add('flex');
            document.getElementById('payment-modal').classList.remove('hidden');

            const qrArea = document.getElementById('qr-display-area');
            const qrImage = document.getElementById('payment-qr-image');
            const qrError = document.getElementById('qr-error-message');

            if (qrCodeBase64) {
                qrImage.src = `data:image/png;base64,${qrCodeBase64}`;
                qrArea.classList.remove('hidden');
                qrError.classList.add('hidden');
            } else {
                qrArea.classList.remove('hidden'); 
                qrImage.src = 'https://placehold.co/192x192/A0A0A0/FFFFFF?text=QR+Not+Set';
                qrError.classList.remove('hidden');
            }

            // Event listener for payment mode change
            document.getElementById('payment-mode').onchange = (e) => {
                if (e.target.value === 'upi') {
                    qrArea.classList.remove('hidden');
                } else {
                    qrArea.classList.add('hidden');
                }
            };
        }

        /**
         * Completes the transaction: saves to temporary sales, updates inventory (in-memory), and clears cart.
         */
        function completeTransaction() {
            if (cart.length === 0) {
                showToast("Transaction failed: Cart is empty.", 'error');
                return;
            }

            const total = calculateTotal();
            const paymentMode = document.getElementById('payment-mode').value;
            
            // 1. Update Inventory (In-Memory)
            for (const item of cart) {
                const stockData = inventory[item.itemId] || { stockKg: 0, stockUnits: 0 };
                let stockKey = '';
                let quantityDeducted = item.quantity;

                if (item.unit === 'units') {
                    stockKey = 'stockUnits';
                } else if (item.unit === 'grams') {
                    stockKey = 'stockKg';
                    quantityDeducted = quantityDeducted / 1000; // Grams to Kg deduction
                } else if (item.unit === 'kilograms') {
                    stockKey = 'stockKg';
                }
                
                if (stockKey) {
                    // Update the in-memory inventory
                    stockData[stockKey] = Math.max(0, stockData[stockKey] - quantityDeducted);
                    inventory[item.itemId] = stockData;
                }
            }

            // 2. Add to Temporary Sales Log
            const saleRecord = {
                timestamp: new Date(),
                totalAmount: total,
                paymentMode: paymentMode,
                items: cart.map(item => ({
                    id: item.itemId,
                    name: item.item.nameEn,
                    qty: item.quantity,
                    unit: item.unit,
                    price: item.price,
                })),
            };
            salesHistory.push(saleRecord);

            // 3. Success and Cleanup
            document.getElementById('payment-modal').classList.add('hidden');
            clearCart();
            renderMenu(); // Re-render menu to show updated stock
            showToast(`Sale completed successfully! Total: ${formatCurrency(total)}`, 'success');
        }

        /**
         * Generates and opens a print-friendly view of the current bill.
         */
        function printBill() {
            if (cart.length === 0) {
                showToast("Cart is empty. Cannot print bill.", 'error');
                return;
            }

            const total = calculateTotal();
            let billHtml = `
                <div class="p-6">
                    <h1 class="text-3xl font-extrabold text-center mb-1">V S TRADERS</h1>
                    <p class="text-center text-sm mb-4">Invoice (விலைப்பட்டியல்) - ${new Date().toLocaleString()}</p>
                    <hr class="border-t-2 border-black mb-4">
                    <div class="flex font-bold mb-1">
                        <span class="w-1/2">Item (பொருள்)</span>
                        <span class="w-1/4 text-center">Qty/Unit (அளவு/அலகு)</span>
                        <span class="w-1/4 text-right">Price (விலை)</span>
                    </div>
                    <hr class="border-t border-gray-400 mb-1">
            `;
            
            cart.forEach(item => {
                const quantityText = item.unit === 'units' 
                    ? `${item.quantity} Unit(s)`
                    : `${item.quantity} ${item.unit}`;

                billHtml += `
                    <div class="flex text-sm py-1">
                        <span class="w-1/2">${item.item.nameEn} (${item.item.nameTa})</span>
                        <span class="w-1/4 text-center">${quantityText}</span>
                        <span class="w-1/4 text-right">${formatCurrency(item.price)}</span>
                    </div>
                `;
            });

            billHtml += `
                    <hr class="border-t border-gray-400 mt-4">
                    <div class="flex justify-between font-bold text-xl mt-2">
                        <span>TOTAL (மொத்தம்)</span>
                        <span>${formatCurrency(total)}</span>
                    </div>
                    <hr class="border-t-2 border-black mt-4">
                    <p class="text-center text-xs mt-4">Thank you for shopping with V S TRADERS!</p>
                </div>
            `;
            
            document.getElementById('report-content').innerHTML = billHtml;
            
            // Wait for DOM update before printing
            setTimeout(() => window.print(), 100);
        }

        /**
         * Shares the current bill via a WhatsApp link.
         */
        function shareBill() {
            if (cart.length === 0) {
                showToast("Cart is empty. Nothing to share.", 'error');
                return;
            }

            const total = calculateTotal();
            let message = `V S TRADERS Bill\nTotal: ${formatCurrency(total)}\n\nItems:\n`;

            cart.forEach(item => {
                const quantityText = item.unit === 'units' 
                    ? `${item.quantity} Unit(s)`
                    : `${item.quantity} ${item.unit}`;
                message += `- ${item.item.nameEn} (${item.item.nameTa}): ${quantityText} @ ${formatCurrency(item.price)}\n`;
            });
            message += "\nThank you!";

            // Encode the message and open WhatsApp
            const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            showToast("Opening WhatsApp with bill details...", 'success');
        }


        // ==================================== UI RENDERING ====================================

        /**
         * Renders the product cards in the main menu area.
         */
        function renderMenu() {
            const menuContainer = document.getElementById('product-menu');
            menuContainer.innerHTML = '';

            if (menuItems.length === 0) {
                menuContainer.innerHTML = `<p class="col-span-full text-center py-10 text-gray-500">
                    No items in menu. Use 'Manage Menu' to add items.
                </p>`;
                return;
            }

            menuItems.forEach(item => {
                const stockKg = inventory[item.id]?.stockKg || 0;
                const stockUnits = inventory[item.id]?.stockUnits || 0;
                
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-lg hover:shadow-xl transition duration-300 overflow-hidden border border-gray-100';
                
                let selectOptions = '';
                if (item.priceKg > 0) {
                    selectOptions += `<option value="kilograms">Kg (${formatCurrency(item.priceKg)}/Kg)</option>`;
                }
                if ((item.priceGram || 0) > 0) {
                    selectOptions += `<option value="grams">g (${formatCurrency(item.priceGram)}/g)</option>`;
                } else if (item.priceKg > 0) {
                    selectOptions += `<option value="grams">g (${formatCurrency(item.priceKg / 1000)}/g)</option>`;
                }
                if (item.priceUnit > 0) {
                    selectOptions += `<option value="units">Unit (${formatCurrency(item.priceUnit)}/Unit)</option>`;
                }

                const imageUrl = item.imageUrl || `https://placehold.co/200x150/4CAF50/FFFFFF?text=${item.nameEn.substring(0, 4).toUpperCase()}`;

                card.innerHTML = `
                    <img src="${imageUrl}" alt="${getDisplayName(item)}" onerror="this.onerror=null;this.src='https://placehold.co/200x150/A0A0A0/FFFFFF?text=Veg';" class="w-full h-32 object-cover">
                    <div class="p-3">
                        <h4 class="text-lg font-bold text-gray-800 truncate">${getDisplayName(item)}</h4>
                        <p class="text-xs text-green-700 font-medium">${getSecondaryName(item)}</p>
                        <p class="text-xs text-gray-500 mt-1">Stock: ${stockKg.toFixed(2)} Kg | ${stockUnits} Units</p>
                        
                        <div class="mt-3 space-y-2">
                            <select id="unit-selector-${item.id}" class="w-full text-sm border-gray-300 rounded-lg p-1.5 focus:ring-green-500 focus:border-green-500">
                                ${selectOptions}
                            </select>
                            <input type="number" id="quantity-input-${item.id}" placeholder="Quantity (அளவு)" value="1" min="0.001" step="any" class="w-full p-2 border rounded-lg text-sm">
                            <button onclick="addToCart('${item.id}')" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold text-sm py-2 rounded-lg shadow-md transition duration-200">
                                Add to Cart (வண்டியில் சேர்)
                            </button>
                        </div>
                    </div>
                `;
                menuContainer.appendChild(card);
            });
        }


        // ==================================== MANAGER MODALS (MENU/STOCK) ====================================

        /**
         * Opens the main manager modal and loads the appropriate content.
         */
        function openManagerModal(view) {
            const modal = document.getElementById('generic-modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');

            title.textContent = view === 'menu' ? 'Manage Menu (மெனுவை நிர்வகி)' : 'Manage Stock Inventory (பங்கு சரக்கு நிர்வகி)';
            body.innerHTML = ''; // Clear body

            if (view === 'menu') {
                renderMenuManager(body);
            } else if (view === 'inventory') {
                renderInventoryManager(body);
            }

            modal.classList.add('flex');
            modal.classList.remove('hidden');
        }

        /**
         * Renders the Menu management interface (CRUD for items).
         */
        function renderMenuManager(body) {
            // 1. New Item Form
            body.innerHTML = `
                <div class="p-4 border rounded-lg bg-indigo-50 mb-6">
                    <h4 class="font-bold text-lg mb-3">Add New Item</h4>
                    <form id="new-item-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="nameEn" placeholder="Name (English, e.g., Onion)" required class="p-2 border rounded-lg">
                        <input type="text" id="nameTa" placeholder="Name (Tamil, e.g., வெங்காயம்)" required class="p-2 border rounded-lg">
                        <input type="number" id="priceKg" placeholder="Price per Kg (e.g., 50)" step="0.01" min="0" required class="p-2 border rounded-lg">
                        <input type="number" id="priceGram" placeholder="Price per Gram (e.g., 0.05)" step="0.0001" min="0" class="p-2 border rounded-lg">
                        <input type="number" id="priceUnit" placeholder="Price per Unit (e.g., 5)" step="0.01" min="0" class="p-2 border rounded-lg">
                        <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                            <input type="file" id="imageFile" accept="image/*" class="p-2 border rounded-lg" />
                            <div class="flex items-center space-x-3">
                                <img id="imagePreview" src="https://placehold.co/64x64/A0A0A0/FFFFFF?text=IMG" alt="Preview" class="w-16 h-16 object-cover rounded" />
                                <span class="text-xs text-gray-500">Optional item image</span>
                            </div>
                        </div>
                        <div class="md:col-span-2">
                            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg transition duration-200">
                                Add Item
                            </button>
                        </div>
                    </form>
                </div>
            `;
            const imgInput = document.getElementById('imageFile');
            const imgPreview = document.getElementById('imagePreview');
            imgInput.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) {
                    imgPreview.src = 'https://placehold.co/64x64/A0A0A0/FFFFFF?text=IMG';
                    return;
                }
                const reader = new FileReader();
                reader.onload = () => { imgPreview.src = reader.result; };
                reader.readAsDataURL(file);
            };

            document.getElementById('new-item-form').onsubmit = (e) => {
                e.preventDefault();
                const baseData = {
                    nameEn: document.getElementById('nameEn').value,
                    nameTa: document.getElementById('nameTa').value,
                    priceKg: parseFloat(document.getElementById('priceKg').value),
                    priceGram: parseFloat(document.getElementById('priceGram').value) || 0,
                    priceUnit: parseFloat(document.getElementById('priceUnit').value) || 0,
                };
                const file = imgInput.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = () => {
                        saveMenuItem({ ...baseData, imageUrl: reader.result });
                    };
                    reader.readAsDataURL(file);
                } else {
                    saveMenuItem(baseData);
                }
            };

            // 2. Existing Items List (Redesigned with thumbnails)
            let listHtml = '<h4 class="font-bold text-lg mb-3">Existing Items</h4>';
            menuItems.forEach(item => {
                const thumb = item.imageUrl || `https://placehold.co/64x64/4CAF50/FFFFFF?text=${item.nameEn.substring(0,2).toUpperCase()}`;
                listHtml += `
                    <div class="p-3 mb-3 bg-white rounded-xl border shadow-sm hover:shadow-md transition flex items-center">
                        <img src="${thumb}" alt="${item.nameEn}" class="w-14 h-14 rounded-lg object-cover border mr-4" onerror="this.onerror=null;this.src='https://placehold.co/64x64/A0A0A0/FFFFFF?text=IMG';" />
                        <div class="flex-1">
                            <div class="flex items-center justify-between">
                                <p class="font-semibold text-gray-900">${item.nameEn} <span class="text-gray-500 text-xs">(${item.nameTa})</span></p>
                                <div class="text-xs">
                                    <span class="inline-block bg-green-100 text-green-800 px-2 py-0.5 rounded mr-1">Kg: ₹${(item.priceKg||0).toFixed(2)}</span>
                                    <span class="inline-block bg-teal-100 text-teal-800 px-2 py-0.5 rounded mr-1">g: ₹${(item.priceGram||((item.priceKg||0)/1000)).toFixed(2)}</span>
                                    <span class="inline-block bg-blue-100 text-blue-800 px-2 py-0.5 rounded">Unit: ₹${(item.priceUnit||0).toFixed(2)}</span>
                                </div>
                            </div>
                            <div class="mt-2 flex space-x-2">
                                <button onclick="editMenuItem('${item.id}')" class="px-3 py-1 text-sm bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow">Edit</button>
                                <button onclick="deleteMenuItem('${item.id}')" class="px-3 py-1 text-sm bg-red-600 hover:bg-red-700 text-white rounded-lg shadow">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            body.innerHTML += `<div class="mt-6">${listHtml}</div>`;
        }
        
        /**
         * Saves a new menu item to memory.
         */
        function saveMenuItem(itemData) {
            const newItem = {
                ...itemData,
                id: `item${nextItemId++}` // Simple ID generation
            };
            menuItems.push(newItem);
            inventory[newItem.id] = { stockKg: 0, stockUnits: 0 }; // Initialize stock
            showToast(`Item '${itemData.nameEn}' added successfully!`, 'success');
            // Re-render the menu manager and the main menu
            renderMenuManager(document.getElementById('modal-body'));
            renderMenu();
        }

        /**
         * Deletes a menu item from memory.
         */
        function deleteMenuItem(itemId) {
            if (!confirm("Are you sure you want to delete this menu item?")) return;

            menuItems = menuItems.filter(item => item.id !== itemId);
            delete inventory[itemId];
            cart = cart.filter(item => item.itemId !== itemId); // Remove from cart

            showToast("Item deleted successfully!", 'success');
            renderMenuManager(document.getElementById('modal-body')); // Re-render manager
            renderMenu(); // Re-render main menu
            renderCart(); // Re-render cart
        }

        /**
         * Handles editing of a menu item (simple prompt for now).
         */
        function editMenuItem(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;

            const body = document.getElementById('modal-body');
            const thumb = item.imageUrl || 'https://placehold.co/100x100/A0A0A0/FFFFFF?text=IMG';
            body.innerHTML = `
                <div class="p-4 border rounded-xl bg-white shadow-sm">
                    <h4 class="font-bold text-lg mb-4">Edit Item</h4>
                    <form id="edit-item-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Name (English)</label>
                            <input type="text" id="edit-nameEn" value="${item.nameEn}" required class="p-2 border rounded-lg w-full">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Name (Tamil)</label>
                            <input type="text" id="edit-nameTa" value="${item.nameTa}" required class="p-2 border rounded-lg w-full">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Price per Kg</label>
                            <input type="number" id="edit-priceKg" value="${item.priceKg}" step="0.01" min="0" required class="p-2 border rounded-lg w-full">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Price per Gram</label>
                            <input type="number" id="edit-priceGram" value="${item.priceGram || ''}" step="0.0001" min="0" class="p-2 border rounded-lg w-full">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Price per Unit</label>
                            <input type="number" id="edit-priceUnit" value="${item.priceUnit}" step="0.01" min="0" required class="p-2 border rounded-lg w-full">
                        </div>
                        <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Change Image</label>
                                <input type="file" id="edit-imageFile" accept="image/*" class="p-2 border rounded-lg w-full" />
                            </div>
                            <div class="flex items-center space-x-3">
                                <img id="edit-imagePreview" src="${thumb}" alt="Preview" class="w-20 h-20 object-cover rounded border" />
                                <span class="text-xs text-gray-500">Current/Selected image</span>
                            </div>
                        </div>
                        <div class="md:col-span-2 flex justify-end space-x-3 mt-2">
                            <button type="button" id="edit-cancel" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Save Changes</button>
                        </div>
                    </form>
                </div>
            `;

            const imgInput = document.getElementById('edit-imageFile');
            const imgPreview = document.getElementById('edit-imagePreview');
            let newImageDataUrl = null;
            imgInput.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) { newImageDataUrl = null; imgPreview.src = thumb; return; }
                const reader = new FileReader();
                reader.onload = () => { newImageDataUrl = reader.result; imgPreview.src = newImageDataUrl; };
                reader.readAsDataURL(file);
            };

            document.getElementById('edit-cancel').onclick = () => {
                renderMenuManager(body);
            };

            document.getElementById('edit-item-form').onsubmit = (e) => {
                e.preventDefault();
                item.nameEn = document.getElementById('edit-nameEn').value;
                item.nameTa = document.getElementById('edit-nameTa').value;
                item.priceKg = parseFloat(document.getElementById('edit-priceKg').value) || 0;
                item.priceGram = parseFloat(document.getElementById('edit-priceGram').value) || 0;
                item.priceUnit = parseFloat(document.getElementById('edit-priceUnit').value) || 0;
                if (newImageDataUrl) item.imageUrl = newImageDataUrl;

                showToast('Item updated successfully!', 'success');
                renderMenuManager(body);
                renderMenu();
            };
        }

        /**
         * Renders the Stock Inventory management interface.
         */
        function renderInventoryManager(body) {
            // Inventory Update Form
            let formHtml = '<h4 class="font-bold text-lg mb-3">Update Stock</h4>';
            formHtml += '<form id="inventory-update-form" class="space-y-4">';

            if (menuItems.length === 0) {
                 formHtml += `<p class="text-gray-500">No menu items found. Add items in 'Manage Menu' first.</p>`;
            } else {
                menuItems.forEach(item => {
                    const stockKg = inventory[item.id]?.stockKg || 0;
                    const stockUnits = inventory[item.id]?.stockUnits || 0;
                    
                    formHtml += `
                        <div class="p-3 border rounded-lg bg-gray-50">
                            <p class="font-semibold text-gray-800 mb-2">${item.nameEn} (${item.nameTa})</p>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs text-gray-500">Stock (Kg)</label>
                                    <input type="number" id="kg-${item.id}" value="${stockKg.toFixed(2)}" step="0.01" min="0" class="w-full p-2 border rounded-lg text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500">Stock (Units)</label>
                                    <input type="number" id="unit-${item.id}" value="${stockUnits}" step="1" min="0" class="w-full p-2 border rounded-lg text-sm">
                                </div>
                            </div>
                        </div>
                    `;
                });
                formHtml += `
                    <button type="submit" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 rounded-lg transition duration-200">
                        Save All Stock Changes
                    </button>
                `;
            }

            formHtml += '</form>';
            body.innerHTML = formHtml;

            if (menuItems.length > 0) {
                document.getElementById('inventory-update-form').onsubmit = (e) => {
                    e.preventDefault();
                    saveInventoryUpdates();
                };
            }
        }

        /**
         * Saves all inventory updates to memory.
         */
        function saveInventoryUpdates() {
            menuItems.forEach(item => {
                const kgInput = document.getElementById(`kg-${item.id}`);
                const unitInput = document.getElementById(`unit-${item.id}`);
                
                inventory[item.id] = {
                    stockKg: parseFloat(kgInput.value) || 0,
                    stockUnits: parseInt(unitInput.value) || 0,
                };
            });

            showToast("Inventory updated successfully!", 'success');
            renderInventoryManager(document.getElementById('modal-body'));
            renderMenu();
        }


        // ==================================== REPORTING ====================================

        /**
         * Opens the reports selection modal.
         */
        function openReportsModal() {
            const modal = document.getElementById('generic-modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');

            title.textContent = 'Sales and Stock Reports (விற்பனை மற்றும் பங்கு அறிக்கைகள்)';
            body.innerHTML = `
                <div class="space-y-4">
                    <button onclick="generateReport('dailyStock')" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                        Generate Daily Stock Report (தினசரி பங்கு அறிக்கை)
                    </button>
                    <button onclick="generateReport('monthlySales')" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                        Generate All Sales History Report (அனைத்து விற்பனை அறிக்கை)
                    </button>
                    <div id="report-message" class="text-center mt-4 text-sm text-gray-600">Reports will be opened in a print-friendly window (Print to PDF).</div>
                </div>
            `;
            modal.classList.add('flex');
            modal.classList.remove('hidden');
        }

        /**
         * Generates the requested report and prepares it for printing (PDF).
         */
        function generateReport(type) {
            document.getElementById('report-message').textContent = 'Generating report...';
            document.getElementById('report-message').classList.add('animate-pulse');

            let reportHtml = '';
            
            if (type === 'dailyStock') {
                reportHtml = generateDailyStockReport();
            } else if (type === 'monthlySales') {
                reportHtml = generateAllSalesHistoryReport();
            }

            document.getElementById('report-content').innerHTML = reportHtml;
            document.getElementById('report-message').classList.remove('animate-pulse');
            document.getElementById('report-message').textContent = 'Report ready. Opening print window...';
            
            // Wait for DOM update before printing
            setTimeout(() => window.print(), 300);
            
            // Close modal after print initiated
            setTimeout(() => {
                document.getElementById('generic-modal').classList.add('hidden');
            }, 500);
        }

        /**
         * Formats the Daily Stock Report from in-memory inventory.
         */
        function generateDailyStockReport() {
            const date = new Date().toLocaleDateString();
            
            let html = `
                <div class="p-6">
                    <h1 class="text-3xl font-extrabold text-center mb-1">V S TRADERS</h1>
                    <h2 class="text-xl font-semibold text-center mb-4">Daily Stock Report (${date})</h2>
                    <hr class="border-t-2 border-black mb-4">
                    <div class="flex font-bold mb-1">
                        <span class="w-1/2">Item (பொருள்)</span>
                        <span class="w-1/4 text-center">Stock (Kg)</span>
                        <span class="w-1/4 text-right">Stock (Units)</span>
                    </div>
                    <hr class="border-t border-gray-400 mb-1">
            `;

            menuItems.forEach(item => {
                const stockKg = inventory[item.id]?.stockKg || 0;
                const stockUnits = inventory[item.id]?.stockUnits || 0;
                
                html += `
                    <div class="flex text-sm py-1">
                        <span class="w-1/2">${item.nameEn} (${item.nameTa})</span>
                        <span class="w-1/4 text-center">${stockKg.toFixed(2)}</span>
                        <span class="w-1/4 text-right">${stockUnits}</span>
                    </div>
                `;
            });

            html += `
                    <hr class="border-t-2 border-black mt-4">
                    <p class="text-center text-xs mt-4">Report Generated by POS System.</p>
                </div>
            `;
            return html;
        }

        /**
         * Formats the All Sales History Report from in-memory salesHistory.
         */
        function generateAllSalesHistoryReport() {
            let totalSales = salesHistory.reduce((sum, record) => sum + record.totalAmount, 0);

            let html = `
                <div class="p-6">
                    <h1 class="text-3xl font-extrabold text-center mb-1">V S TRADERS</h1>
                    <h2 class="text-xl font-semibold text-center mb-4">All Sales History Report (Current Session)</h2>
                    <hr class="border-t-2 border-black mb-4">
                    <div class="flex font-bold mb-1">
                        <span class="w-1/3">Date/Time</span>
                        <span class="w-1/3 text-center">Payment Mode</span>
                        <span class="w-1/3 text-right">Amount (விலை)</span>
                    </div>
                    <hr class="border-t border-gray-400 mb-1">
            `;

            if (salesHistory.length === 0) {
                html += '<p class="text-center py-4 text-sm">No sales recorded during this session.</p>';
            } else {
                salesHistory.forEach(record => {
                    const dateString = record.timestamp.toLocaleString();
                    html += `
                        <div class="flex text-sm py-1">
                            <span class="w-1/3">${dateString}</span>
                            <span class="w-1/3 text-center">${record.paymentMode.toUpperCase()}</span>
                            <span class="w-1/3 text-right">${formatCurrency(record.totalAmount)}</span>
                        </div>
                    `;
                });
            }

            html += `
                    <hr class="border-t-2 border-black mt-4">
                    <div class="flex justify-between font-bold text-xl mt-2">
                        <span>Total Sales (மொத்தம்)</span>
                        <span>${formatCurrency(totalSales)}</span>
                    </div>
                    <hr class="border-t-2 border-black mt-4">
                    <p class="text-center text-xs mt-4">Report Generated by POS System.</p>
                </div>
            `;
            return html;
        }

    </script>
</body>
</html>